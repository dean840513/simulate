<!DOCTYPE html>
<html lang="zh">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>è‘¡è„é…’NFTæ¨¡æ‹Ÿå¹³å°</title>
    <link rel="stylesheet" href="style.css">
    <style>
        #detailView,
        #mainView {
            animation: fadeIn 0.4s ease-in-out;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
    </style>
</head>

<body>
    <header>
        <h1>è‘¡è„é…’ NFT æ¨¡æ‹Ÿ</h1>
        <div class="wallet-info">
            <div class="wallet-row">
                <button id="connectBtn" class="primary-button">ğŸ² æ¨¡æ‹Ÿè¿æ¥é’±åŒ…</button>
                <span id="walletAddress" style="display:none;"></span>
            </div>
            <div class="wallet-row">
                <span id="grapeBalance" style="display:none;">ğŸ‡ æˆ‘çš„è‘¡è„ï¼š0</span>
            </div>
        </div>
    </header>

    <div class="hero">
        <h2>æ¬¢è¿æ¥åˆ°é“¾ä¸Šé…¿é…’æ¨¡æ‹Ÿå¹³å°</h2>
        <p>ä½“éªŒä»è´­ä¹°è‘¡è„åˆ°å¯„å”®é…’æ¬¾çš„å®Œæ•´æµç¨‹</p>
    </div>

    <div class="grid" id="mainView">
        <div class="card" onclick="loadDetail('buy.html')">
            <img src="grapes.png" alt="è´­ä¹°è‘¡è„" />
            <h3>ğŸ‡ è´­ä¹°è‘¡è„</h3>
            <button class="primary-button">ç«‹å³è´­ä¹°</button>
        </div>

        <div class="card" onclick="loadDetail('vote.html')">
            <img src="vote.png" alt="é…¿é€ æŠ•ç¥¨" />
            <h3>ğŸ—³ï¸ é…¿é€ æŠ•ç¥¨</h3>
            <button class="primary-button">æŠ•ç¥¨</button>
        </div>

        <div class="card" onclick="loadDetail('redeem.html')">
            <img src="wine.png" alt="å…‘æ¢è‘¡è„é…’" />
            <h3>ğŸ· é¢†å–è‘¡è„é…’</h3>
            <button class="primary-button">å…‘æ¢é…’NFT</button>
        </div>

        <div class="card" onclick="loadDetail('consign.html')">
            <img src="store.png" alt="å¯„å”®" />
            <h3>ğŸª å¯„å”®é…’NFT</h3>
            <button class="primary-button">å¯„å”®ä¸€ç“¶é…’</button>
        </div>
    </div>

    <div class="section" id="detailView" style="display: none;"></div>

    <div id="walletOverlay" style="display: none;" class="wallet-overlay">
        <div class="wallet-dialog">
            <div class="spinner"></div>
            <p>æ­£åœ¨ä¸é’±åŒ…äº¤äº’ï¼Œè¯·ç¨å€™...</p>
        </div>
    </div>

    <div style="margin: 40px auto; text-align: center;">
        <button onclick="loadDetail('admin.html')" class="secondary-button">ğŸ§¾ ç®¡ç†å‘˜åˆ†è´¦æ¨¡æ‹Ÿ</button>
    </div>


    <script>
        let users = {}, currentUser = null, queue = [], nftId = 1;

        function connectWallet() {
            const random = '0x' + [...Array(40)].map(() => Math.floor(Math.random() * 16).toString(16)).join('');
            if (!users[random]) users[random] = { grapes: 0, locked: 0, wineNFTs: [], usdt: 0 };
            currentUser = random;
            let shortAddr = `${random.slice(0, 6)}...${random.slice(-4)}`;
            document.getElementById("walletAddress").innerText = `é’±åŒ…åœ°å€ï¼š${shortAddr}`;
            document.getElementById("walletAddress").style.display = 'inline';
            document.getElementById("grapeBalance").style.display = 'inline';
            updateUI();
            document.getElementById("connectBtn").style.display = 'none';
            localStorage.setItem("currentUser", currentUser);
        }

        function updateUI() {
            document.getElementById("grapeBalance").innerText = `ğŸ‡ æˆ‘çš„è‘¡è„ï¼š${users[currentUser].grapes}ï½œğŸ”’ å·²é”å®šï¼š${users[currentUser].locked}`;
        }

        document.getElementById("connectBtn").onclick = connectWallet;

        window.onload = () => {
            const saved = localStorage.getItem("currentUser");
            if (saved) {
                currentUser = saved;
                if (!users[currentUser]) users[currentUser] = { grapes: 0, locked: 0, wineNFTs: [], usdt: 0 };
                // users[currentUser].grapes = 1000;
                // users[currentUser].locked = 500;
                let shortAddr = `${currentUser.slice(0, 6)}...${currentUser.slice(-4)}`;
                document.getElementById("walletAddress").innerText = `é’±åŒ…åœ°å€ï¼š${shortAddr}`;
                document.getElementById("walletAddress").style.display = 'inline';
                document.getElementById("grapeBalance").style.display = 'inline';
                updateUI();
                document.getElementById("connectBtn").style.display = 'none';
            }

            const lastPage = localStorage.getItem("lastPage");
            if (lastPage) {
                loadDetail(lastPage, false);
            }

            window.addEventListener("popstate", () => {
                const current = history.state?.page;
                if (current) loadDetail(current, false);
                else showMain();
            });
        };

        function loadDetail(filename, push = true) {
            fetch(filename)
                .then(res => res.text())
                .then(html => {
                    document.getElementById("mainView").style.display = 'none';
                    document.getElementById("detailView").innerHTML = html;
                    document.getElementById("detailView").style.display = 'block';
                    if (push) history.pushState({ page: filename }, '', '#' + filename);
                    localStorage.setItem("lastPage", filename);
                    if (filename === 'redeem.html') {
                        setTimeout(() => renderNFTList(), 0);
                    }
                    if (filename === 'consign.html') {
                        setTimeout(() => renderConsignPage(), 0);
                    }
                    if (filename === 'vote.html') {
                        setTimeout(() => {
                            if (users[currentUser]?.voted) {
                                renderVoteSuccess();
                            }
                        }, 0);

                    }
                });
        }

        function showMain() {
            document.getElementById("detailView").style.display = 'none';
            document.getElementById("mainView").style.display = 'grid';
            history.pushState({}, '', location.pathname);
            localStorage.removeItem("lastPage");
        }

        document.addEventListener("click", function (e) {
            if (e.target && e.target.id === "buyButton") {
                const amt = parseInt(document.getElementById("buyAmount").value);
                if (isNaN(amt) || amt <= 0) return alert("è¯·è¾“å…¥æœ‰æ•ˆçš„è´­ä¹°æ•°é‡");

                const status = document.getElementById("buyStatus");
                const confirmed = confirm(`ç¡®è®¤è¦è´­ä¹° ${amt} é¢—è‘¡è„å—ï¼Ÿ`);
                if (!confirmed) return;
                showWalletOverlay(); // æ˜¾ç¤ºåŠ è½½å¼¹çª—

                setTimeout(() => {
                    users[currentUser].grapes += amt;
                    status.innerHTML = `
                        âœ… æˆåŠŸè´­ä¹° ${amt} é¢—è‘¡è„ï¼<br>
                        <a href="#" onclick="loadDetail('vote.html'); return false;" style="color: #4caf50; text-decoration: underline;">
                            ğŸ‘‰ ç‚¹å‡»å»æŠ•ç¥¨é…¿é€ 
                        </a>
                        `;
                    updateUI();
                    hideWalletOverlay(); // éšè—å¼¹çª—
                }, 1000);
            }
        });

        let voteSelections = {
            type: null,
            country: null,
            region: null,
            oak: null,
            price: null
        };

        // ç‚¹å‡»é€‰é¡¹å¡ç»‘å®šé€»è¾‘
        document.addEventListener("click", function (e) {
            if (e.target.classList.contains("option") && !e.target.classList.contains("disabled")) {
                const group = e.target.closest(".option-row");
                const field = group.dataset.field;
                if (!field) return;

                // æ¸…é™¤åŒç»„å…¶ä»–æŒ‰é’® active çŠ¶æ€
                [...group.querySelectorAll(".option")].forEach(btn => btn.classList.remove("active"));
                e.target.classList.add("active");
                voteSelections[field] = e.target.dataset.value;
                updateVoteSummary();
            }
        });

        // æ±‡æ€»å±•ç¤ºå‡½æ•°
        function updateVoteSummary() {
            const summary = document.getElementById("voteSummary");
            if (!summary) return;
            summary.innerHTML = `
            <li>ğŸ· ç±»å‹ï¼š${voteSelections.type || "æœªé€‰æ‹©"}</li>
            <li>ğŸŒ å›½å®¶ï¼š${voteSelections.country || "æœªé€‰æ‹©"}</li>
            <li>ğŸ“ äº§åŒºï¼š${voteSelections.region || "æœªé€‰æ‹©"}</li>
            <li>ğŸªµ æ©¡æœ¨æ¡¶ï¼š${voteSelections.oak || "æœªé€‰æ‹©"}</li>
            <li>ğŸ’° æœŸæœ›å”®ä»·ï¼š${voteSelections.price || "æœªé€‰æ‹©"}</li>
            `;
        }

        // ç¡®è®¤æŠ•ç¥¨æŒ‰é’®é€»è¾‘
        document.addEventListener("click", function (e) {
            if (e.target && e.target.id === "voteButton") {
                const user = users[currentUser];
                const voteInput = document.getElementById("voteAmount");
                const amount = parseInt(voteInput?.value || "0");

                if (!amount || amount < 100 || amount % 100 !== 0) {
                    return alert("è¯·è¾“å…¥ 100 çš„å€æ•°çš„è‘¡è„æ•°é‡è¿›è¡ŒæŠ•ç¥¨");
                }

                if (user.grapes < amount) {
                    return alert(`ğŸ‡ ä½ åªæœ‰ ${user.grapes} é¢—è‘¡è„ï¼Œæ— æ³•æŠ• ${amount}`);
                }

                const fields = Object.entries(voteSelections);
                const unfilled = fields.filter(([_, v]) => !v);
                if (unfilled.length > 0) return alert("è¯·å…ˆå®Œæˆæ‰€æœ‰æŠ•ç¥¨é¡¹é€‰æ‹©");

                const confirmMsg =
                    `ç¡®è®¤æŠ•ç¥¨å¦‚ä¸‹ï¼š\n` +
                    fields.map(([k, v]) => `${k}ï¼š${v}`).join('\n') +
                    `\nå°†æ¶ˆè€— ${amount} é¢—è‘¡è„ï¼Œæ˜¯å¦ç»§ç»­ï¼Ÿ`;

                if (!confirm(confirmMsg)) return;

                showWalletOverlay();
                setTimeout(() => {
                    user.grapes -= amount;
                    user.locked += amount;
                    user.voted = true; // âœ… è®¾ç½®ä¸ºå·²æŠ•ç¥¨
                    updateUI();
                    hideWalletOverlay();
                    renderVoteSuccess(); // âœ… æ˜¾ç¤ºæŠ•ç¥¨æˆåŠŸçŠ¶æ€
                }, 1000);
            }
        });

        function renderVoteSuccess() {
            const body = document.querySelector(".detail-body");
            if (!body) return;

            const user = users[currentUser];
            body.innerHTML = `
                <p style="font-size:16px; color: green; margin-bottom: 10px;">
                âœ… ä½ å·²æˆåŠŸæŠ•ç¥¨ï¼Œå½“å‰å·²é”å®š ${user.locked} é¢—è‘¡è„
                <br>ğŸ“… æŠ•ç¥¨ç»“æŸæ—¶é—´ï¼š2026/1/1
                </p>

                <h3>ğŸ‡ è¿½åŠ æŠ•ç¥¨è‘¡è„</h3>
                <div style="display: flex; gap: 10px; margin-bottom: 10px;">
                <input id="extraVoteAmount" type="number" min="100" step="100" value="100" style="flex:1; padding: 8px;" />
                <button id="maxExtraVote" class="max-button">Max</button>
                </div>
                <button id="extraVoteButton" class="primary-button">â• ç¡®è®¤è¿½åŠ </button>
                <button onclick="window.showMain()" class="secondary-button">ğŸ  è¿”å›ä¸»é¡µ</button>

                <p style="font-size: 12px; color: #555; margin-top: 10px;">
                æç¤ºï¼šè¿½åŠ çš„è‘¡è„å°†ä½¿ç”¨åŸæŠ•ç¥¨é€‰é¡¹ï¼Œä¸èƒ½ä¿®æ”¹ã€‚
                </p>

                <button id="mockEndButton" class="secondary-button" style="margin-top: 20px;">ğŸ§ª æ¨¡æ‹ŸæŠ•ç¥¨ç»“æŸ</button>
            `;
        }


        document.addEventListener("click", function (e) {
            if (e.target && e.target.id === "mockEndButton") {
                const body = document.querySelector(".detail-body");
                if (!body) return;
                body.innerHTML = `
                    <p style="font-size:16px; color: green;">
                        ğŸ æŠ•ç¥¨å·²ç»“æŸï¼Œä½ å¯å‰å¾€é¢†å–é…’ NFTã€‚
                    </p>
                    <button onclick="loadDetail('redeem.html')" class="primary-button" style="margin-top: 10px;">
                        ğŸ· å»é¢†å– NFT
                    </button>
                    `;
            }
        });

        document.addEventListener("click", function (e) {
            // Max æŒ‰é’®å¡«å……å‰©ä½™å¯æŠ•è‘¡è„
            if (e.target && e.target.id === "maxExtraVote") {
                const input = document.getElementById("extraVoteAmount");
                const max = Math.floor(users[currentUser].grapes / 100) * 100;
                if (input) input.value = max > 0 ? max : 100;
            }

            // è¿½åŠ æŒ‰é’®æ‰§è¡Œé€»è¾‘
            if (e.target && e.target.id === "extraVoteButton") {
                const input = document.getElementById("extraVoteAmount");
                const amount = parseInt(input?.value || "0");
                const user = users[currentUser];

                if (!amount || amount < 100 || amount % 100 !== 0) {
                    return alert("è¯·è¾“å…¥ 100 çš„å€æ•°çš„è‘¡è„æ•°é‡è¿›è¡Œè¿½åŠ ");
                }
                if (user.grapes < amount) {
                    return alert(`ğŸ‡ ä½ åªæœ‰ ${user.grapes} é¢—è‘¡è„ï¼Œæ— æ³•è¿½åŠ  ${amount}`);
                }

                if (!confirm(`ç¡®è®¤è¦è¿½åŠ  ${amount} é¢—è‘¡è„ç”¨äºå½“å‰æŠ•ç¥¨é€‰é¡¹ï¼Ÿ`)) return;

                showWalletOverlay();
                setTimeout(() => {
                    user.grapes -= amount;
                    user.locked += amount;
                    updateUI();
                    hideWalletOverlay();
                    renderVoteSuccess();
                }, 1000);
            }
        });


        document.addEventListener("click", function (e) {
            if (e.target && e.target.id === "maxVote") {
                const input = document.getElementById("voteAmount");
                const max = Math.floor(users[currentUser].grapes / 100) * 100;
                if (input) input.value = max > 0 ? max : 100;
            }
        });

        document.addEventListener("click", function (e) {
            if (e.target && e.target.id === "redeemButton") {
                const user = users[currentUser];
                const count = Math.floor(user.locked / 100);
                if (count === 0) return alert("ğŸ”’ æ²¡æœ‰è¶³å¤Ÿé”å®šçš„è‘¡è„å¯å…‘æ¢é…’ NFT");

                if (!confirm(`ä½ å°†å…‘æ¢ ${count} ç“¶è‘¡è„é…’ NFTï¼Œæ˜¯å¦ç»§ç»­ï¼Ÿ`)) return;

                showWalletOverlay();
                setTimeout(() => {
                    for (let i = 0; i < count; i++) {
                        user.wineNFTs.push(nftId++);
                    }
                    user.locked -= count * 100;
                    updateUI();
                    renderNFTList();
                    hideWalletOverlay();
                    const result = document.getElementById("redeemResult");
                    if (result) {
                        result.innerHTML = `
                            âœ… æˆåŠŸé¢†å– ${count} ç“¶ NFTï¼<br>
                            ğŸ‘‰ <a href="#" onclick="loadDetail('consign.html'); return false;" style="color: #4caf50; text-decoration: underline;">
                            éœ€è¦å¯„å”®ï¼Ÿç‚¹å‡»å»å¯„å”®
                            </a>
                        `;
                    }
                }, 1000);
            }
        });

        function renderNFTList() {
            const list = document.getElementById("nftList");
            if (!list) return;
            list.innerHTML = "";
            users[currentUser].wineNFTs.forEach(id => {
                const li = document.createElement("li");
                li.textContent = `NFT #${id}`;
                list.appendChild(li);
            });

            const lockedEl = document.getElementById("lockedGrapes");
            if (lockedEl) lockedEl.innerText = users[currentUser].locked;
        }

        function renderConsignPage() {
            if (!document.getElementById("consignList")) return;
            document.getElementById("myWineCount").innerText = users[currentUser].wineNFTs.length;

            const list = document.getElementById("consignList");
            list.innerHTML = "";
            queue.forEach((item, i) => {
                const li = document.createElement("li");
                const isSelf = item.user === currentUser;
                const shortAddr_consign = `${item.user.slice(0, 6)}...${item.user.slice(-4)}`;
                li.textContent = `${i + 1}. ${isSelf ? "ğŸ§â€â™‚ï¸ " : ""}${shortAddr_consign}${item.paid ? " âœ…å·²å”®" : ""}`;

                list.appendChild(li);
            });

            const incomeEl = document.getElementById("myIncome");
            if (incomeEl) incomeEl.innerText = users[currentUser].usdt || 0;
        }


        document.addEventListener("click", function (e) {
            if (e.target && e.target.id === "consignButton") {
                const input = document.getElementById("consignAmount");
                let count = parseInt(input?.value || "0");
                const user = users[currentUser];
                const available = user.wineNFTs.length;

                if (isNaN(count) || count <= 0) return alert("è¯·è¾“å…¥æœ‰æ•ˆå¯„å”®æ•°é‡");
                if (count > available) return alert(`ä½ åªæœ‰ ${available} ç“¶é…’ NFT å¯å¯„å”®`);

                if (!confirm(`æ˜¯å¦å¯„å”® ${count} ç“¶è‘¡è„é…’ï¼Ÿ`)) return;

                showWalletOverlay();
                setTimeout(() => {
                    for (let i = 0; i < count; i++) {
                        const nft = user.wineNFTs.pop();
                        queue.push({ user: currentUser, nft, paid: false });
                    }
                    updateUI();
                    renderConsignPage();
                    hideWalletOverlay();
                    alert(`âœ… å·²æˆåŠŸå¯„å”® ${count} ç“¶é…’ NFT`);
                }, 1000);
            }
        });


        document.addEventListener("click", function (e) {
            if (e.target && e.target.id === "maxConsign") {
                const input = document.getElementById("consignAmount");
                if (input) input.value = users[currentUser].wineNFTs.length;
            }
        });







        function showWalletOverlay() {
            document.getElementById("walletOverlay").style.display = "flex";
        }

        function hideWalletOverlay() {
            document.getElementById("walletOverlay").style.display = "none";
        }



        document.addEventListener("click", function (e) {
            if (e.target && e.target.id === "settleButton") {
                const sold = parseInt(document.getElementById("soldCount").value);
                const revenue = parseInt(document.getElementById("revenue").value);
                if (isNaN(sold) || isNaN(revenue) || sold <= 0 || revenue <= 0) {
                    return alert("è¯·è¾“å…¥æœ‰æ•ˆçš„ç“¶æ•°ä¸æ”¶å…¥");
                }

                const unsoldCount = queue.filter(item => !item.paid).length;
                if (sold > unsoldCount) {
                    return alert(`å½“å‰å°šæœªå”®å‡ºçš„ NFT ä»…æœ‰ ${unsoldCount} ç“¶ï¼Œæ— æ³•ç»“ç®— ${sold} ç“¶`);
                }

                // âš ï¸ å¼¹çª—ç¡®è®¤å‰ä¸æ‰§è¡Œå®é™…æ“ä½œ
                if (!confirm(`å°†è¦åˆ†å‘æ”¶ç›Šï¼Œæ˜¯å¦ç¡®è®¤æ‰§è¡Œåˆ†è´¦ï¼Ÿ`)) return;

                const unit = Math.floor(revenue / sold);
                let paid = 0;
                for (let i = 0; i < queue.length && paid < sold; i++) {
                    const item = queue[i];
                    if (!item.paid) {
                        users[item.user].usdt = (users[item.user].usdt || 0) + unit;
                        item.paid = true;
                        paid++;
                    }
                }

                updateUI?.();
                renderConsignPage?.();
                alert(`âœ… åˆ†è´¦å®Œæˆï¼Œå…±å‘æ”¾ ${paid} ä»½ï¼Œæ¯ä»½ ${unit} USDT`);
            }
        });

        document.addEventListener("input", function (e) {
            const sold = parseInt(document.getElementById("soldCount")?.value || "0");
            const unit = parseFloat(document.getElementById("unitPrice")?.value || "0");
            const revenue = parseFloat(document.getElementById("revenue")?.value || "0");

            // ä¿®æ”¹å•ä»·æ—¶ï¼Œè‡ªåŠ¨æ›´æ–°æ€»æ”¶å…¥
            if (e.target.id === "unitPrice" && sold > 0) {
                document.getElementById("revenue").value = (unit * sold).toFixed(2);
            }

            // ä¿®æ”¹æ€»æ”¶å…¥æ—¶ï¼Œè‡ªåŠ¨æ›´æ–°å•ä»·
            if (e.target.id === "revenue" && sold > 0) {
                document.getElementById("unitPrice").value = (revenue / sold).toFixed(2);
            }

            // ä¿®æ”¹å”®å‡ºæ•°é‡æ—¶ï¼Œæ ¹æ®å·²æœ‰çš„å•ä»·æˆ–æ”¶å…¥æ›´æ–°å¦ä¸€ä¸ª
            if (e.target.id === "soldCount") {
                if (unit > 0) {
                    document.getElementById("revenue").value = (unit * sold).toFixed(2);
                } else if (revenue > 0) {
                    document.getElementById("unitPrice").value = (revenue / sold).toFixed(2);
                }
            }
        });




    </script>
</body>

</html>